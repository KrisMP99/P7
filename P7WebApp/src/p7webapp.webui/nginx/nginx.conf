load_module /usr/lib/nginx/modules/ngx_http_auth_jwt_module.so;
load_module /usr/lib/nginx/modules/ngx_http_cache_purge_module.so;

worker_processes auto;

error_log error.log debug;

worker_rlimit_nofile 100000;

events {
    worker_connections 10000; 
    use epoll;
    multi_accept on;
}

http {

    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:100m inactive=60m use_temp_path=off;

    keepalive_requests 1000000;
    proxy_read_timeout 3000;
    proxy_connect_timeout 3000;
    proxy_send_timeout 3000;

    upstream web-api {
        server p7webapp_api-PROD:5000;
    }

    map $request_body $course_id {
        ~\"id\"\s*:\s*((?:[0-9])*)  $1;
        default 0;
    }
    map $course_id $url {
        ~^0     "";
        default "$proxy_host|/api/courses/$course_id";
    }

    map $request_method $purge_method {
        PUT my_cache;
        GET 0;
        HEAD 0;
    }

    server {
        listen 80;
        server_name $hostname;

        proxy_cache my_cache;

        index index.html index.htm;
        
        location / {
            include /etc/nginx/mime.types;
            sendfile on;
            root /var/www/;
            try_files $uri /index.html;
        }

        location ~ /purge/(.*) { 
            cache_purge_response_type json;
            proxy_cache_key "$proxy_host|$request_uri";
            proxy_cache_purge my_cache $1;
        }

        location ~ /api/profiles/([0-9]+)/ {
            auth_jwt_key "YMa%tfgkz-4ursfc8?g%mdv6rhJNWYV@HRsn5m9jD$M5u*+#_r+=ZL?cf3Q5E6fDvT*QA@pQQAFWVzE*9JGA+_Ckza@J5rrpuD-YLePK2M#Ez=xP7VY2bAT2BmT7Z4cJBv3uM59!zuh$hcrfpU+h7YKpxbUKd3VFpn48#!!BSEy6CbM_vycC-A#SyBje7j75rWj8tDqEemGP^HEKX6VGJ$UpfTbLcY@?zBQ3$m%mFSE3p*Zc@$t+kP@z*RaJF-bd";
            auth_jwt on;
            auth_jwt_alg HS256;

            proxy_ignore_headers Expires;
            proxy_ignore_headers X-Accel-Expires;
            proxy_ignore_headers Cache-Control;
            proxy_ignore_headers Set-Cookie;

            proxy_hide_header X-Accel-Expires;
            proxy_hide_header Expires;
            proxy_hide_header Cache-Control;
            proxy_hide_header Pragma;
            
            proxy_cache_methods GET HEAD POST;
            proxy_cache_key "$proxy_host|$request_uri|$request_body";
            proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
            proxy_cache_lock on;

            proxy_cache_valid 200 302 60h;
            proxy_cache_valid any 60m;

            add_header Cache-Control "max-age=3600, public";

            add_header X-Cache-Status $upstream_cache_status;

            proxy_pass         http://web-api;
        }

        location /api/profiles {
            auth_jwt off;
            proxy_ignore_headers Expires;
            proxy_ignore_headers X-Accel-Expires;
            proxy_ignore_headers Cache-Control;
            proxy_ignore_headers Set-Cookie;

            proxy_hide_header X-Accel-Expires;
            proxy_hide_header Expires;
            proxy_hide_header Cache-Control;
            proxy_hide_header Pragma;
            
            proxy_cache_methods GET HEAD POST;
            proxy_cache_key "$proxy_host|$request_uri|$request_body";
            proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
            proxy_cache_lock on;

            proxy_cache_valid 200 302 60h;
            proxy_cache_valid any 60m;

            add_header Cache-Control "max-age=3600, public";

            add_header X-Cache-Status $upstream_cache_status;

            proxy_pass         http://web-api;
        }

        location /api/courses/update {
            # mirror /mirror
            # mirror_request_body off;

            cache_purge_response_type json;
            proxy_cache_key "$proxy_host|$request_uri";
            proxy_cache_purge my_cache $url;

           # auth_jwt_key "YMa%tfgkz-4ursfc8?g%mdv6rhJNWYV@HRsn5m9jD$M5u*+#_r+=ZL?cf3Q5E6fDvT*QA@pQQAFWVzE*9JGA+_Ckza@J5rrpuD-YLePK2M#Ez=xP7VY2bAT2BmT7Z4cJBv3uM59!zuh$hcrfpU+h7YKpxbUKd3VFpn48#!!BSEy6CbM_vycC-A#SyBje7j75rWj8tDqEemGP^HEKX6VGJ$UpfTbLcY@?zBQ3$m%mFSE3p*Zc@$t+kP@z*RaJF-bd";
           # auth_jwt on;
            #auth_jwt_alg HS256;

           # proxy_cache_purge my_cache *;

           # add_header X-p-method "$purge_method $url";
            #add_header X-cach-key "$proxy_host|$request_uri";

           proxy_pass         http://web-api;
        }

        location /api/courses {
            # mirror /mirror
            # mirror_request_body off;

            auth_jwt_key "YMa%tfgkz-4ursfc8?g%mdv6rhJNWYV@HRsn5m9jD$M5u*+#_r+=ZL?cf3Q5E6fDvT*QA@pQQAFWVzE*9JGA+_Ckza@J5rrpuD-YLePK2M#Ez=xP7VY2bAT2BmT7Z4cJBv3uM59!zuh$hcrfpU+h7YKpxbUKd3VFpn48#!!BSEy6CbM_vycC-A#SyBje7j75rWj8tDqEemGP^HEKX6VGJ$UpfTbLcY@?zBQ3$m%mFSE3p*Zc@$t+kP@z*RaJF-bd";
            auth_jwt on;
            auth_jwt_alg HS256;

            proxy_ignore_headers Expires;
            proxy_ignore_headers X-Accel-Expires;
            proxy_ignore_headers Cache-Control;
            proxy_ignore_headers Set-Cookie;

            proxy_hide_header X-Accel-Expires;
            proxy_hide_header Expires;
            proxy_hide_header Cache-Control;
            proxy_hide_header Pragma;

            proxy_cache_methods GET HEAD;
            proxy_cache_key "$proxy_host|$request_uri";
            proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
            # proxy_cache_lock on;
            proxy_cache_valid 200 302;
            # proxy_cache_valid 200 302 60h;
            # proxy_cache_valid any 60m;

            add_header Cache-Control "max-age=3600, public";
            add_header X-cach-key "$proxy_host|$request_uri";

            add_header X-Cache-Status $upstream_cache_status;

            proxy_pass         http://web-api;
        }

        
        # location /mirror {
        #     internal;
        #     proxy_pass_request_body off;
        #     proxy_set_header Content-Length "";
            
        #     auth_jwt_key "YMa%tfgkz-4ursfc8?g%mdv6rhJNWYV@HRsn5m9jD$M5u*+#_r+=ZL?cf3Q5E6fDvT*QA@pQQAFWVzE*9JGA+_Ckza@J5rrpuD-YLePK2M#Ez=xP7VY2bAT2BmT7Z4cJBv3uM59!zuh$hcrfpU+h7YKpxbUKd3VFpn48#!!BSEy6CbM_vycC-A#SyBje7j75rWj8tDqEemGP^HEKX6VGJ$UpfTbLcY@?zBQ3$m%mFSE3p*Zc@$t+kP@z*RaJF-bd";
        #     auth_jwt on;
        #     auth_jwt_alg HS256;

        #     if ($request_method ~ "HEAD|GET") {
        #         return 204;
        #     }

        #     proxy_ignore_headers Expires;
        #     proxy_ignore_headers X-Accel-Expires;
        #     proxy_ignore_headers Cache-Control;
        #     proxy_ignore_headers Set-Cookie;

        #     proxy_hide_header X-Accel-Expires;
        #     proxy_hide_header Expires;
        #     proxy_hide_header Cache-Control;
        #     proxy_hide_header Pragma;

        #     proxy_cache_purge my_cache "$proxy_host|$request_uri";

        #     proxy_pass         http://web-api;
        # }
    }
}